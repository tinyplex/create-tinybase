import {createStore} from 'tinybase';

{{#if typescript}}
  export const app = () => {
{{else}}
  const app = () => {
{{/if}}
const store = createStore()
.setRow('settings', 'brush', {color: '#d81b60', size: 5})
.setTable('strokes', {});

const canvas = document.getElementById('drawing-canvas') as HTMLCanvasElement;
const ctx = canvas!.getContext('2d')!;
let isDrawing = false;

const draw = () => {
ctx.fillStyle = '#111';
ctx.fillRect(0, 0, canvas!.width, canvas!.height);

const strokes = store.getTable('strokes');
Object.values(strokes).forEach((stroke: any) => {
ctx.fillStyle = stroke.color;
ctx.beginPath();
ctx.arc(stroke.x, stroke.y, stroke.size, 0, Math.PI * 2);
ctx.fill();
});
};

const addStroke = (e: MouseEvent | TouchEvent) => {
const rect = canvas!.getBoundingClientRect();
const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;
const clientY = 'touches' in e ? e.touches[0].clientY : e.clientY;
const brush = store.getRow('settings', 'brush'){{#if typescript}} as any{{/if}};

store.addRow('strokes', {
x: clientX - rect.left,
y: clientY - rect.top,
color: brush.color,
size: brush.size,
});
};

canvas!.addEventListener('mousedown', () => { isDrawing = true; });
canvas!.addEventListener('mouseup', () => { isDrawing = false; });
canvas!.addEventListener('mouseleave', () => { isDrawing = false; });

canvas!.addEventListener('mousemove', (e) => {
if (isDrawing) addStroke(e);
});

canvas!.addEventListener('touchstart', (e) => {
isDrawing = true;
e.preventDefault();
});

canvas!.addEventListener('touchmove', (e) => {
if (isDrawing) {
addStroke(e);
e.preventDefault();
}
});

canvas!.addEventListener('touchend', () => {
isDrawing = false;
});

// Color buttons
const colors = ['#d81b60', '#1976d2', '#388e3c', '#f57c00', '#7b1fa2', '#fff'];
colors.forEach((color) => {
const btn = document.createElement('button');
btn.className = 'color-btn';
btn.style.background = color;
btn.addEventListener('click', () => {
const brush = store.getRow('settings', 'brush') as any;
store.setRow('settings', 'brush', {...brush, color});
});
document.getElementById('color-picker')!.appendChild(btn);
});

// Size slider
const sizeSlider = document.getElementById('brush-size') as HTMLInputElement;
const sizeLabel = document.getElementById('brush-size-value')!;

sizeSlider!.addEventListener('input', () => {
const brush = store.getRow('settings', 'brush') as any;
const size = parseInt(sizeSlider!.value);
store.setRow('settings', 'brush', {...brush, size});
sizeLabel.textContent = `${size}`;
});

// Clear button
document.getElementById('clear-button')!.addEventListener('click', () => {
store.delTable('strokes');
});

store.addTablesListener(draw);
draw();
};
{{#unless typescript}}
  export {app};
{{/unless}}