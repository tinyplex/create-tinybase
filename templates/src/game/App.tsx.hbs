import {StrictMode} from 'react';
import {createMergeableStore} from 'tinybase';
import {Provider, useCreateStore, useSetValuesCallback, useStore, useTableListener} from 'tinybase/ui-react';
import {Inspector} from 'tinybase/ui-react-inspector';
{{includeFile template="src/components/Button.tsx.hbs" output="src/components/Button.{{ext}}"}}
import {Button} from '../components/Button';
{{includeFile template="src/components/Board.tsx.hbs" output="src/components/Board.{{ext}}"}}
import {Board} from '../components/Board';
{{includeFile template="src/components/GameStatus.tsx.hbs" output="src/components/GameStatus.{{ext}}"}}
import {GameStatus} from '../components/GameStatus';

const WINNING_LINES = [
[0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
[0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
[0, 4, 8], [2, 4, 6], // diagonals
];

const Game = () => {
const store = useStore();

useTableListener(
'board',
() => {
const gameStatus = store.getValue('gameStatus');
if (gameStatus !== 'playing') return;

const board = store.getTable('board');

// Check for winner
for (const line of WINNING_LINES) {
const [a, b, c] = line;
const cellA = board[a]?.value;
const cellB = board[b]?.value;
const cellC = board[c]?.value;

if (cellA && cellA === cellB && cellA === cellC) {
store.setValue('gameStatus', 'won');
store.setValue('winner', cellA);
store.setValue('winningLine', line.join(','));
return;
}
}

// Check for draw
const filledCells = Object.values(board).filter((cell: any) => cell.value).length;
if (filledCells === 9) {
store.setValue('gameStatus', 'draw');
return;
}

// Switch player after each move
const currentPlayer = store.getValue('currentPlayer');
store.setValue('currentPlayer', currentPlayer === 'X' ? 'O' : 'X');
},
[],
true,
);

const resetGame = useSetValuesCallback(
() => {
store.delTable('board');
return {
currentPlayer: 'X',
gameStatus: 'playing',
};
},
[],
);

return (
<>
  <GameStatus />
  <Board />
  <div style=\{{textAlign: 'center', marginTop: '2rem'}}>
    <Button onClick={resetGame} variant="primary">New Game</Button>
  </div>
  <Inspector />
</>
);
};

const App = () => {
const store = useCreateStore(() => {
return createMergeableStore('game')
.setValue('currentPlayer', 'X')
.setValue('gameStatus', 'playing');
});

return (
<StrictMode>
  <Provider store={store}>
    <Game />
  </Provider>
</StrictMode>
);
};

export {App};