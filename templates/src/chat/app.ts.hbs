import {createStore, createMergeableStore} from 'tinybase';
{{includeFile template="src/components/button.ts.hbs" output="src/components/button.{{ext}}"}}
import {createButton} from '../components/button';
{{includeFile template="src/components/input.ts.hbs" output="src/components/input.{{ext}}"}}
import {createInput} from '../components/input';
{{includeFile template="src/chat/message.ts.hbs" output="src/chat/message.{{ext}}"}}
import {createMessage} from './message';
{{includeFile template="src/chat/messages.ts.hbs" output="src/chat/messages.{{ext}}"}}
import {createMessages} from './messages';
{{includeFile template="src/chat/usernameInput.ts.hbs" output="src/chat/usernameInput.{{ext}}"}}
import {createUsernameInput} from './usernameInput';
{{includeFile template="src/chat/messageInput.ts.hbs" output="src/chat/messageInput.{{ext}}"}}
import {createMessageInput} from './messageInput';

const app = () => {
const settingsStore = createStore().setValue('username', 'Carol');

const chatStore = createMergeableStore('chat').setTable('messages', {
'1': {username: 'Alice', text: 'Hello!', timestamp: Date.now() - 60000},
'2': {username: 'Bob', text: 'Hi there!', timestamp: Date.now() - 30000},
});

const appContainer = document.getElementById('app')!;

appContainer.appendChild(createUsernameInput(settingsStore, chatStore));

const messagesContainer = createMessages(chatStore);
appContainer.appendChild(messagesContainer);

const messageInputContainer = createMessageInput(settingsStore, chatStore);
appContainer.appendChild(messageInputContainer);

// Focus the input after it's in the DOM
const messageInput = messageInputContainer.querySelector('input')!;
messageInput.focus();

chatStore.addTablesListener(() => {
const messageRows = chatStore.getTable('messages');
const sortedIds = Object.keys(messageRows).sort(
(a, b) => messageRows[a].timestamp - messageRows[b].timestamp,
);

messagesContainer.innerHTML = '';
sortedIds.forEach((id) => {
const msg = messageRows[id];
const messageElement = createMessage(msg.username, msg.text, msg.timestamp);
messagesContainer.appendChild(messageElement);
});
});
};

export {app};