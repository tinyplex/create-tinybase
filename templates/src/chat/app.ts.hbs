{{includeFile template="src/components/button.ts.hbs" output="src/components/button.{{ext}}"}}
{{includeFile template="src/components/input.ts.hbs" output="src/components/input.{{ext}}"}}
import {createStore} from 'tinybase';
import {createButton} from './components/button';
import {createInput} from './components/input';

const updateMessages = (store: any) => {
const messages = document.getElementById('messages')!;
const messageRows = store.getTable('messages');
const sortedIds = Object.keys(messageRows).sort(
(a, b) => messageRows[a].timestamp - messageRows[b].timestamp,
);

messages.innerHTML = sortedIds
.map((id) => {
const msg = messageRows[id];
const time = new Date(msg.timestamp).toLocaleTimeString();
return `
<div class="message">
  <span class="username">${msg.username}:</span>
  <span class="text">${msg.text}</span>
  <span class="time">${time}</span>
</div>
`;
})
.join('');
};

{{#if typescript}}
  export const app = () => {
{{else}}
  const app = () => {
{{/if}}
const store = createStore()
.setValue('username', 'Carol')
.setTable('messages', {
'1': {username: 'Alice', text: 'Hello!', timestamp: Date.now() - 60000},
'2': {username: 'Bob', text: 'Hi there!', timestamp: Date.now() - 30000},
});

const usernameInput = createInput('Enter your name', store.getValue('username') as string);
document.querySelector('.username-input')!.appendChild(usernameInput);

usernameInput.addEventListener('input', () => {
store.setValue('username', usernameInput.value);
});

store.addValuesListener(() => {
usernameInput.value = store.getValue('username') as string;
});

const messageInput = createInput('Type a message...');
const messageInputContainer = document.querySelector('.message-input')!;
messageInputContainer.appendChild(messageInput);

const sendMessage = () => {
const text = messageInput.value.trim();
if (text) {
store.addRow('messages', {
username: store.getValue('username'),
text,
timestamp: Date.now(),
});
messageInput.value = '';
}
};

messageInput.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
sendMessage();
}
});

const sendButton = createButton('Send', sendMessage, 'primary');
messageInputContainer.appendChild(sendButton);

store.addTablesListener(() => updateMessages(store));
updateMessages(store);
};
{{#unless typescript}}
  export {app};
{{/unless}}