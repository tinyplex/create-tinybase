{{includeFile template="src/components/Button.tsx.hbs" output="src/components/Button.{{ext}}"}}
{{includeFile template="src/components/Input.tsx.hbs" output="src/components/Input.{{ext}}"}}
import {StrictMode, useState, useMemo} from 'react';
import {createStore} from 'tinybase';
import {Provider, useCreateStore, useAddRowCallback, useRow, useSetValueCallback, useValue, useRowIds, useStore} from 'tinybase/ui-react';
import {Inspector} from 'tinybase/ui-react-inspector';
import {Button} from './components/Button';
import {Input} from './components/Input';

const MessageInput = () => {
const [message, setMessage] = useState('');
const username = useValue('username') || 'Anonymous';

const handleSend = useAddRowCallback(
'messages',
() => ({
username,
text: message,
timestamp: Date.now(),
}),
[message, username],
);

const onSubmit = (e: React.FormEvent) => {
e.preventDefault();
if (message.trim()) {
handleSend();
setMessage('');
}
};

return (
<form onSubmit={onSubmit} className="message-input">
  <Input value={message} onChange={setMessage} placeholder="Type a message..." autoFocus />
      <Button type="submit" variant="primary">Send</Button>
    </form>
  );
};

const Message = ({rowId}: {rowId: string}) => {
  const row = useRow('messages', rowId);
  const time = new Date((row as any).timestamp).toLocaleTimeString();

  return (
    <div className="message">
      <span className="username">{(row as any).username}:</span>
      <span className="text">{(row as any).text}</span>
      <span className="time">{time}</span>
    </div>
  );
};

const Messages = () => {
  const store = useStore();
  const messageIds = useRowIds('messages');

  const sortedIds = useMemo(() => {
    return [...messageIds].sort((a, b) => {
      const rowA = store.getRow('messages', a) as any;
      const rowB = store.getRow('messages', b) as any;
      return rowA.timestamp - rowB.timestamp;
    });
  }, [messageIds, store]);

  return (
    <div className="messages">
      {sortedIds.map((id) => (
        <Message key={id} rowId={id} />
      ))}
    </div>
  );
};

const UsernameInput = () => {
const username = useValue('username') || '';
const setUsername = useSetValueCallback(
'username',
    (_e) => _e,[]);

  return (
    <div className="username-input">
      <label>Your name:</label>
      <Input value={username} onChange={setUsername} placeholder="Enter your name" />
    </div>
  );
};

export const App = () => {
const store = useCreateStore(() => {
return createStore()
.setValue('username', 'Carol')
.setTable('messages', {
'1': {username: 'Alice', text: 'Hello!', timestamp: Date.now() - 60000},
'2': {username: 'Bob', text: 'Hi there!', timestamp: Date.now() - 30000},
});
});

return (
<StrictMode>
  <Provider store={store}>
    <UsernameInput />
    <Messages />
    <MessageInput />
    <Inspector />
  </Provider>
</StrictMode>
);
};