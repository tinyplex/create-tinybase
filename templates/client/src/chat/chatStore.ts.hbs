{{#if schemas}}
  {{addImport "import {createMergeableStore, type Row} from 'tinybase/with-schemas';"}}
{{else}}
  {{addImport "import {createMergeableStore} from 'tinybase';"}}
{{/if}}

{{includeFile template="client/src/chat/utils.ts.hbs" output="client/src/utils.ts"}}
{{addImport "import {getDefaultContent} from './utils';"}}

{{#if schemas}}
  const TABLES_SCHEMA = {
  messages: {
  username: {type: 'string', default: ''},
  text: {type: 'string', default: ''},
  timestamp: {type: 'number', default: 0},
  },
  } as const;

{{/if}}
export const chatStore = createMergeableStore(){{#if schemas}}
  .setTablesSchema(TABLES_SCHEMA){{/if}}
.setDefaultContent(getDefaultContent());

export type MessageRow = {{#if schemas}}Row<typeof TABLES_SCHEMA, 'messages'>{{else}}{username: string; text: string; timestamp: number}{{/if}};

{{#if persist}}
  {{#if persistLocalStorage}}
    {{#if schemas}}
      {{addImport "import {createLocalPersister} from 'tinybase/persisters/persister-browser/with-schemas';"}}
    {{else}}
      {{addImport "import {createLocalPersister} from 'tinybase/persisters/persister-browser';"}}
    {{/if}}

    const chatPersister = createLocalPersister(chatStore, 'chat');
    chatPersister.load().then(() => chatPersister.startAutoSave());
  {{/if}}
  {{#if persistSqlite}}
    {{#if schemas}}
      {{addImport "import {createSqliteWasmPersister} from 'tinybase/persisters/persister-sqlite-wasm/with-schemas';"}}
    {{else}}
      {{addImport "import {createSqliteWasmPersister} from 'tinybase/persisters/persister-sqlite-wasm';"}}
    {{/if}}
    {{includeFile template="client/src/shared/sqlite.ts.hbs" output="client/src/sqlite.ts"}}
    {{addImport "import {getDb} from './sqlite';"}}

    getDb().then(({sqlite3, db}) => {
    const chatPersister = createSqliteWasmPersister(chatStore, sqlite3, db, 'chat');
    chatPersister.load().then(() => chatPersister.startAutoSave());
    });
  {{/if}}
  {{#if persistPglite}}
    {{#if schemas}}
      {{addImport "import {createPglitePersister} from 'tinybase/persisters/persister-pglite/with-schemas';"}}
    {{else}}
      {{addImport "import {createPglitePersister} from 'tinybase/persisters/persister-pglite';"}}
    {{/if}}
    {{addImport "import {PGlite} from '@electric-sql/pglite';"}}

    PGlite.create('idb://chat').then((pgLite) => {
    const chatPersister = createPglitePersister(chatStore, pgLite, 'chat');
    chatPersister.load().then(() => chatPersister.startAutoSave());
    });
  {{/if}}
{{/if}}

{{#if sync}}
  {{includeFile template="client/src/shared/config.ts.hbs" output="client/src/config.ts"}}
  {{addImport "import {SERVER} from './config';"}}
  {{addImport "import ReconnectingWebSocket from 'reconnecting-websocket';"}}
  {{#if schemas}}
    {{addImport "import {createWsSynchronizer} from 'tinybase/synchronizers/synchronizer-ws-client/with-schemas';"}}
  {{else}}
    {{addImport "import {createWsSynchronizer} from 'tinybase/synchronizers/synchronizer-ws-client';"}}
  {{/if}}

  const serverPathId = location.pathname;
  createWsSynchronizer(
  chatStore,
  new ReconnectingWebSocket(SERVER + serverPathId),
  ).then(async (synchronizer) => {
  await synchronizer.startSync();

  synchronizer.getWebSocket().addEventListener('open', () => {
  synchronizer.load().then(() => synchronizer.save());
  });
  });
{{/if}}

export type ChatStore = typeof chatStore;