{{#if schemas}}
  {{addImport "import {createStore} from 'tinybase/with-schemas';"}}
  {{addImport "import * as UiReact from 'tinybase/ui-react/with-schemas';"}}
  {{addImport "import {type NoTablesSchema} from 'tinybase/with-schemas';"}}
{{else}}
  {{addImport "import {createStore} from 'tinybase';"}}
  {{addImport "import {useCreateStore, useProvideStore, useValue, useValueState} from 'tinybase/ui-react';"}}
{{/if}}

{{includeFile template="client/src/chat/utils.ts.hbs" output="client/src/utils.{{ext}}"}}
{{addImport "import {getRandomName} from './utils';"}}

export const STORE_ID = 'settings';

{{#if schemas}}
  const VALUES_SCHEMA = {
  username: {type: 'string'},
  } as const;

  type Schemas = [NoTablesSchema, typeof VALUES_SCHEMA];

  const {useCreateStore, {{#if persist}}useCreatePersister, {{/if}}useProvideStore, useValue, useValueState} = UiReact as UiReact.WithSchemas<Schemas>;
{{/if}}

export {useValue, useValueState};

export const SettingsStore = () => {
const store = useCreateStore(() =>
createStore(){{#if schemas}}
  .setValuesSchema(VALUES_SCHEMA){{/if}}
.setValue('username', getRandomName()),
);

useProvideStore(STORE_ID, store);

{{#if persist}}
  {{#if persistLocalStorage}}
    {{#if schemas}}
      {{addImport "import {createLocalPersister} from 'tinybase/persisters/persister-browser/with-schemas';"}}
    {{else}}
      {{addImport "import {createLocalPersister} from 'tinybase/persisters/persister-browser';"}}
      {{addImport "import {useCreatePersister} from 'tinybase/ui-react';"}}
    {{/if}}

    useCreatePersister(
    store,
    (store) => createLocalPersister(store, STORE_ID),
    [],
    async (persister) => {
    await persister.load();
    await persister.startAutoSave();
    },
    );
  {{/if}}
  {{#if persistSqlite}}
    {{#if schemas}}
      {{addImport "import {createSqliteWasmPersister} from 'tinybase/persisters/persister-sqlite-wasm/with-schemas';"}}
    {{else}}
      {{addImport "import {createSqliteWasmPersister} from 'tinybase/persisters/persister-sqlite-wasm';"}}
      {{addImport "import {useCreatePersister} from 'tinybase/ui-react';"}}
    {{/if}}
    {{includeFile template="client/src/shared/sqlite.ts.hbs" output="client/src/sqlite.{{ext}}"}}
    {{addImport "import {getDb} from './sqlite';"}}

    useCreatePersister(
    store,
    async (store) => {
    const {sqlite3, db} = await getDb();
    return createSqliteWasmPersister(store, sqlite3, db, STORE_ID);
    },
    [],
    async (persister) => {
    await persister.load();
    await persister.startAutoSave();
    },
    );
  {{/if}}
  {{#if persistPglite}}
    {{#if schemas}}
      {{addImport "import {createPglitePersister} from 'tinybase/persisters/persister-pglite/with-schemas';"}}
    {{else}}
      {{addImport "import {createPglitePersister} from 'tinybase/persisters/persister-pglite';"}}
      {{addImport "import {useCreatePersister} from 'tinybase/ui-react';"}}
    {{/if}}
    {{addImport "import {PGlite} from '@electric-sql/pglite';"}}

    useCreatePersister(
    store,
    async (store) => {
    const pgLite = await PGlite.create('idb://' + STORE_ID);
    return createPglitePersister(store, pgLite, STORE_ID);
    },
    [],
    async (persister) => {
    await persister.load();
    await persister.startAutoSave();
    },
    );
  {{/if}}
{{/if}}

return null;
};