{{#if schemas}}
  {{addImport "import {createStore} from 'tinybase/with-schemas';"}}
{{else}}
  {{addImport "import {createStore} from 'tinybase';"}}
{{/if}}

{{includeFile template="client/src/chat/utils.ts.hbs" output="client/src/utils.ts"}}
{{addImport "import {getRandomName} from './utils';"}}

{{#if schemas}}
  const VALUES_SCHEMA = {
  username: {type: 'string'},
  } as const;

{{/if}}
export const settingsStore = createStore(){{#if schemas}}
  .setValuesSchema(VALUES_SCHEMA){{/if}};

{{#if persist}}
  {{#if persistLocalStorage}}
    {{#if schemas}}
      {{addImport "import {createLocalPersister} from 'tinybase/persisters/persister-browser/with-schemas';"}}
    {{else}}
      {{addImport "import {createLocalPersister} from 'tinybase/persisters/persister-browser';"}}
    {{/if}}

    const settingsPersister = createLocalPersister(settingsStore, 'settings');
    settingsPersister.load([{}, {username: getRandomName()}]).then(() => settingsPersister.startAutoSave());
  {{/if}}
  {{#if persistSqlite}}
    {{#if schemas}}
      {{addImport "import {createSqliteWasmPersister} from 'tinybase/persisters/persister-sqlite-wasm/with-schemas';"}}
    {{else}}
      {{addImport "import {createSqliteWasmPersister} from 'tinybase/persisters/persister-sqlite-wasm';"}}
    {{/if}}
    {{includeFile template="client/src/shared/sqlite.ts.hbs" output="client/src/sqlite.ts"}}
    {{addImport "import {getDb} from './sqlite';"}}

    getDb().then(({sqlite3, db}) => {
    const settingsPersister = createSqliteWasmPersister(settingsStore, sqlite3, db, 'settings');
    settingsPersister.load([{}, {username: getRandomName()}]).then(() => settingsPersister.startAutoSave());
    });
  {{/if}}
  {{#if persistPglite}}
    {{#if schemas}}
      {{addImport "import {createPglitePersister} from 'tinybase/persisters/persister-pglite/with-schemas';"}}
    {{else}}
      {{addImport "import {createPglitePersister} from 'tinybase/persisters/persister-pglite';"}}
    {{/if}}
    {{addImport "import {PGlite} from '@electric-sql/pglite';"}}

    PGlite.create('idb://settings').then((pgLite) => {
    const settingsPersister = createPglitePersister(settingsStore, pgLite, 'settings');
    settingsPersister.load([{}, {username: getRandomName()}]).then(() => settingsPersister.startAutoSave());
    });
  {{/if}}
{{else}}
  settingsStore.setValue('username', getRandomName());
{{/if}}

export type SettingsStore = typeof settingsStore;