{{addImport "import type {GameStore} from './store';"}}

{{includeFile template="client/src/shared/button.ts.hbs" output="client/src/button.{{ext}}"}}
{{addImport "import {createButton} from './button';"}}

{{includeFile template="client/src/game/board.ts.hbs" output="client/src/board.{{ext}}"}}
{{addImport "import {createBoard} from './board';"}}

{{includeFile template="client/src/game/gameStatus.ts.hbs" output="client/src/gameStatus.{{ext}}"}}
{{addImport "import {createGameStatus} from './gameStatus';"}}

const WINNING_LINES = [
[0, 1, 2], [3, 4, 5], [6, 7, 8],
[0, 3, 6], [1, 4, 7], [2, 5, 8],
[0, 4, 8], [2, 4, 6],
];

export const createGame = (store: GameStore): HTMLDivElement => {
const checkGameState = () => {
const gameStatus = store.getValue('gameStatus');
if (gameStatus !== 'playing') return;

const board = store.getTable('board');

for (const line of WINNING_LINES) {
const [a, b, c] = line;
const cellA = board[a]?.value;
const cellB = board[b]?.value;
const cellC = board[c]?.value;

if (cellA && cellA === cellB && cellA === cellC) {
store.setValue('gameStatus', 'won');
store.setValue('winner', cellA);
store.setValue('winningLine', line.join(','));
return;
}
}

const filledCells = Object.values(board).filter((cell: any) => cell.value).length;
if (filledCells === 9) {
store.setValue('gameStatus', 'draw');
return;
}

const currentPlayer = store.getValue('currentPlayer');
store.setValue('currentPlayer', currentPlayer === 'X' ? 'O' : 'X');
};

store.addTableListener('board', checkGameState, true);

const resetGame = () => {
store.delTable('board');
store.setValues({
currentPlayer: 'X',
gameStatus: 'playing',
});
};

const gameContainer = document.createElement('div');

gameContainer.appendChild(createGameStatus(store));
gameContainer.appendChild(createBoard(store));

const buttonContainer = document.createElement('div');
buttonContainer.style.textAlign = 'center';
buttonContainer.style.marginTop = '2rem';
buttonContainer.appendChild(createButton('New Game', resetGame, 'primary'));
gameContainer.appendChild(buttonContainer);

return gameContainer;
};