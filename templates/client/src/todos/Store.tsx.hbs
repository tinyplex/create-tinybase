{{#if schemas}}
  {{addImport "import {createMergeableStore, type Row} from 'tinybase/with-schemas';"}}
  {{addImport "import * as UiReact from 'tinybase/ui-react/with-schemas';"}}
  {{addImport "import {type NoValuesSchema} from 'tinybase/with-schemas';"}}

  const TODOS_SCHEMA = {
  todos: {
  text: {type: 'string', default: ''},
  completed: {type: 'boolean', default: false},
  },
  } as const;

  type Schemas = [typeof TODOS_SCHEMA, NoValuesSchema];

  const {useAddRowCallback, useCreateMergeableStore, {{#if persist}}useCreatePersister, {{/if}}useDelRowCallback, useProvideStore, useRow, useSetPartialRowCallback, useSortedRowIds} = UiReact as UiReact.WithSchemas<Schemas>;
{{else}}
  {{addImport "import {createMergeableStore} from 'tinybase';"}}
  {{addImport "import {useCreateMergeableStore, useProvideStore, useAddRowCallback, useDelRowCallback, useRow, useSortedRowIds, useSetPartialRowCallback} from 'tinybase/ui-react';"}}
{{/if}}

export type TodoRow = {{#if schemas}}Row<typeof TODOS_SCHEMA, 'todos'>{{else}}{text: string; completed: boolean}{{/if}};

export {useAddRowCallback, useDelRowCallback, useRow, useSortedRowIds, useSetPartialRowCallback};

export const STORE_ID = 'todos';

export const Store = () => {
const store = useCreateMergeableStore(() =>
createMergeableStore(){{#if schemas}}
  .setTablesSchema(TODOS_SCHEMA){{/if}}
.setDefaultContent([
{
todos: {
'1': {text: 'Learn TinyBase', completed: false},
'2': {text: 'Build an app', completed: false},
},
},
{},
]),
);

useProvideStore(STORE_ID, store);

{{#if persist}}
  {{#if persistLocalStorage}}
    {{#if schemas}}
      {{addImport "import {createLocalPersister} from 'tinybase/persisters/persister-browser/with-schemas';"}}
    {{else}}
      {{addImport "import {createLocalPersister} from 'tinybase/persisters/persister-browser';"}}
      {{addImport "import {useCreatePersister} from 'tinybase/ui-react';"}}
    {{/if}}

    useCreatePersister(
    store,
    (store) => createLocalPersister(store, STORE_ID),
    [],
    async (persister) => {
    await persister.startAutoLoad();
    await persister.startAutoSave();
    },
    );
  {{/if}}
  {{#if persistSqlite}}
    {{#if schemas}}
      {{addImport "import {createSqliteWasmPersister} from 'tinybase/persisters/persister-sqlite-wasm/with-schemas';"}}
    {{else}}
      {{addImport "import {createSqliteWasmPersister} from 'tinybase/persisters/persister-sqlite-wasm';"}}
      {{addImport "import {useCreatePersister} from 'tinybase/ui-react';"}}
    {{/if}}
    {{addImport "import sqlite3InitModule from '@sqlite.org/sqlite-wasm';"}}

    useCreatePersister(
    store,
    async (store) => {
    const sqlite3 = await sqlite3InitModule();
    const db = new sqlite3.oo1.DB(':local:' + STORE_ID, 'c');
    return createSqliteWasmPersister(store, sqlite3, db, STORE_ID);
    },
    [],
    async (persister) => {
    await persister.startAutoLoad();
    await persister.startAutoSave();
    },
    );
  {{/if}}
  {{#if persistPglite}}
    {{#if schemas}}
      {{addImport "import {createPglitePersister} from 'tinybase/persisters/persister-pglite/with-schemas';"}}
    {{else}}
      {{addImport "import {createPglitePersister} from 'tinybase/persisters/persister-pglite';"}}
      {{addImport "import {useCreatePersister} from 'tinybase/ui-react';"}}
    {{/if}}
    {{addImport "import {PGlite} from '@electric-sql/pglite';"}}

    useCreatePersister(
    store,
    async (store) => {
    const pgLite = await PGlite.create('idb://' + STORE_ID);
    return createPglitePersister(store, pgLite, STORE_ID);
    },
    [],
    async (persister) => {
    await persister.startAutoLoad();
    await persister.startAutoSave();
    },
    );
  {{/if}}
{{/if}}

{{#if sync}}
  {{includeFile template="client/src/shared/config.ts.hbs" output="client/src/config.ts"}}
  {{addImport "import {SERVER} from './config';"}}
  {{addImport "import ReconnectingWebSocket from 'reconnecting-websocket';"}}
  {{#if schemas}}
    {{addImport "import {createWsSynchronizer} from 'tinybase/synchronizers/synchronizer-ws-client/with-schemas';"}}
  {{else}}
    {{addImport "import {createWsSynchronizer} from 'tinybase/synchronizers/synchronizer-ws-client';"}}
  {{/if}}
  {{#if schemas}}
    {{addImport "import {useCreateSynchronizer} from 'tinybase/ui-react/with-schemas';"}}
  {{else}}
    {{addImport "import {useCreateSynchronizer} from 'tinybase/ui-react';"}}
  {{/if}}

  useCreateSynchronizer(store, async (store) => {
  const serverPathId = location.pathname;
  const synchronizer = await createWsSynchronizer(
  store,
  new ReconnectingWebSocket(SERVER + serverPathId),
  );
  await synchronizer.startSync();

  synchronizer.getWebSocket().addEventListener('open', () => {
  synchronizer.load().then(() => synchronizer.save());
  });

  return synchronizer;
  });
{{/if}}

return null;
};